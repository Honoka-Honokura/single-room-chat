<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>お題ガチャ 管理画面</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Yu Gothic", sans-serif;
      margin: 16px;
      background: #f3f4f6;
    }
    h1 { font-size: 20px; margin-bottom: 8px; }
    .card {
      background: #ffffff;
      border-radius: 8px;
      padding: 12px 14px;
      box-shadow: 0 1px 3px rgba(15, 23, 42, 0.12);
      margin-bottom: 16px;
    }
    label { font-size: 13px; display: block; margin-bottom: 4px; }
    input[type="password"], input[type="text"], input[type="number"], textarea, select {
      width: 100%;
      box-sizing: border-box;
      padding: 6px 8px;
      font-size: 13px;
      margin-bottom: 8px;
    }
    button {
      padding: 6px 10px;
      font-size: 13px;
      border-radius: 6px;
      border: 1px solid #d1d5db;
      background: #e5e7eb;
      cursor: pointer;
    }
    button.primary { background: #2563eb; border-color: #2563eb; color: #ffffff; }
    button.danger  { background: #dc2626; border-color: #b91c1c; color: #ffffff; }
    button + button { margin-left: 6px; }
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      margin-top: 8px;
    }
    th, td { border: 1px solid #e5e7eb; padding: 6px 8px; vertical-align: top; }
    th { background: #f9fafb; white-space: nowrap; }
    td.text-cell { width: 100%; white-space: pre-wrap; word-break: break-word; }
    .id-cell { width: 40px; text-align: right; }
    .weight-cell { width: 60px; text-align: right; }
    .actions-cell { white-space: nowrap; width: 120px; text-align: center; }
    .status { font-size: 12px; color: #4b5563; margin-top: 4px; min-height: 16px; }
    .status.error { color: #b91c1c; }

    dialog::backdrop { background: rgba(0,0,0,.25); }
    #editDialog { border: none; border-radius: 10px; max-width: 560px; width: 92vw; padding: 0; }
    .dialog-inner {
      padding: 14px 14px 10px;
      background: #fff;
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
      border-radius: 10px;
    }
    .dialog-actions { display: flex; justify-content: flex-end; gap: 8px; margin-top: 10px; }

    .room-pill{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      background:#eef2ff;
      color:#3730a3;
      font-size:12px;
      margin-left:6px;
      border:1px solid #c7d2fe;
      vertical-align: middle;
    }

    .rooms-box{
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 10px 10px 6px;
      background: #fff;
      margin-bottom: 8px;
    }
    .rooms-grid{
      display:flex;
      flex-wrap:wrap;
      gap:8px 12px;
      margin-top: 6px;
    }
    .room-chip{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding: 4px 8px;
      border: 1px solid #e5e7eb;
      border-radius: 999px;
      background: #f9fafb;
      font-size: 12px;
      user-select:none;
    }
    .room-chip input{ transform: translateY(0.5px); }
    .rooms-hint{
      font-size: 12px;
      color: #6b7280;
      margin-top: 6px;
    }
    .badge{
      display:inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      border: 1px solid #e5e7eb;
      background:#f9fafb;
      font-size: 12px;
      margin-left: 6px;
      color:#374151;
      vertical-align: middle;
      white-space: nowrap;
    }
  </style>
</head>
<body>
  <h1>お題ガチャ 管理画面 <span id="roomPill" class="room-pill">room: main</span></h1>

  <div class="card">
    <h2 style="font-size:16px;margin:0 0 8px;">対象ルーム</h2>
    <label for="roomSelect">ルーム（自動判定・手動変更可）</label>
    <select id="roomSelect"></select>

    <label for="adminPassword">管理パスワード</label>
    <input type="password" id="adminPassword" placeholder="server.js の ADMIN_PASSWORD と同じ値" />
    <button id="loadBtn" class="primary">現在のお題を読み込む</button>
    <div id="statusText" class="status"></div>
  </div>

  <div class="card">
    <h2 style="font-size:16px;margin:0 0 8px;">お題の追加</h2>

    <label>対象ルーム（複数選択可）</label>
    <div class="rooms-box">
      <div class="rooms-grid" id="addRoomCheckboxes"></div>
      <div class="rooms-hint">※「全ルーム共通」を選ぶと、他のチェックは無視されます。</div>
    </div>

    <label for="newTopicText">お題テキスト</label>
    <textarea id="newTopicText" rows="3" placeholder="ここに新しいお題を入力（改行OK）"></textarea>

    <label for="newTopicWeight">重み（出やすさ）※1以上の数字</label>
    <input type="number" id="newTopicWeight" value="1" min="1" step="1" />

    <button id="addBtn" class="primary">このお題を追加</button>
  </div>

  <div class="card">
    <h2 style="font-size:16px;margin:0 0 8px;">現在登録されているお題</h2>
    <table>
      <thead>
        <tr>
          <th class="id-cell">ID</th>
          <th class="text-cell">お題テキスト</th>
          <th class="weight-cell">重み</th>
          <th class="actions-cell">操作</th>
        </tr>
      </thead>
      <tbody id="topicsBody"></tbody>
    </table>
  </div>

  <dialog id="editDialog">
    <div class="dialog-inner">
      <h3 style="margin:0 0 10px;font-size:16px;">お題の編集（改行OK）</h3>

      <label>対象ルーム（複数選択可）</label>
      <div class="rooms-box">
        <div class="rooms-grid" id="editRoomCheckboxes"></div>
        <div class="rooms-hint">※「全ルーム共通」を選ぶと、他のチェックは無視されます。</div>
      </div>

      <label for="editTopicText">お題テキスト</label>
      <textarea id="editTopicText" rows="7"></textarea>

      <label for="editTopicWeight">重み（1以上）</label>
      <input type="number" id="editTopicWeight" min="1" step="1" />

      <div class="dialog-actions">
        <button id="editCancelBtn">キャンセル</button>
        <button id="editSaveBtn" class="primary">保存</button>
      </div>

      <div id="editStatus" class="status"></div>
    </div>
  </dialog>

  <script>
    const adminPasswordInput = document.getElementById("adminPassword");
    const loadBtn            = document.getElementById("loadBtn");
    const addBtn             = document.getElementById("addBtn");
    const statusText         = document.getElementById("statusText");
    const topicsBody         = document.getElementById("topicsBody");
    const newTopicText       = document.getElementById("newTopicText");
    const newTopicWeight     = document.getElementById("newTopicWeight");

    const roomSelect         = document.getElementById("roomSelect");
    const roomPill           = document.getElementById("roomPill");

    const addRoomCheckboxes  = document.getElementById("addRoomCheckboxes");
    const editRoomCheckboxes = document.getElementById("editRoomCheckboxes");

    const editDialog         = document.getElementById("editDialog");
    const editTopicText      = document.getElementById("editTopicText");
    const editTopicWeight    = document.getElementById("editTopicWeight");
    const editCancelBtn      = document.getElementById("editCancelBtn");
    const editSaveBtn        = document.getElementById("editSaveBtn");
    const editStatus         = document.getElementById("editStatus");

    let editingId = null;
    let currentTopics = [];

    // ★ ここをあなたの .env の ROOM_SLUGS に合わせて増やしてOK
    // 例: ROOM_SLUGS=main,night,game なら ["main","night","game"]
    const AVAILABLE_ROOMS = ["main", "night"];

    // ---- room helpers ----
    function normalizeRoomSlug(slug) {
      const s = String(slug || "main").trim();
      const safe = s.replace(/[^a-zA-Z0-9_-]/g, "");
      return safe || "main";
    }

    function getRoomFromUrl() {
      const params = new URLSearchParams(location.search);
      const q = params.get("room");
      if (q) return normalizeRoomSlug(q);

      // /r/:slug/xxx を想定（/r/main でも /r/main/admin.html でも拾える）
      const m = location.pathname.match(/^\/r\/([^\/]+)/);
      if (m && m[1]) return normalizeRoomSlug(decodeURIComponent(m[1]));

      return "main";
    }

    async function getAllowedRooms() {
      // サーバに一覧APIが無い前提なので、フロントで持つ
      // + URLから推定されたroomがリストになければ追加（保険）
      const r = getRoomFromUrl();
      const set = new Set(AVAILABLE_ROOMS.map(normalizeRoomSlug));
      if (r) set.add(r);
      set.add("main");
      return Array.from(set);
    }

    async function initRoomSelect() {
      const rooms = await getAllowedRooms();

      roomSelect.innerHTML = "";
      rooms.forEach(r => {
        const opt = document.createElement("option");
        opt.value = r;
        opt.textContent = r;
        roomSelect.appendChild(opt);
      });

      const initial = getRoomFromUrl();
      roomSelect.value = rooms.includes(initial) ? initial : (rooms[0] || "main");
      setRoomPill(roomSelect.value);
    }

    function getSelectedRoom() {
      return normalizeRoomSlug(roomSelect.value || "main");
    }

    function setRoomPill(room) {
      roomPill.textContent = `room: ${room}`;
    }

    roomSelect.addEventListener("change", () => {
      setRoomPill(getSelectedRoom());
      loadTopics();
    });

    // ---- status ----
    function setStatus(message, isError = false) {
      statusText.textContent = message || "";
      statusText.classList.toggle("error", !!isError);
    }
    function setEditStatus(message, isError = false) {
      editStatus.textContent = message || "";
      editStatus.classList.toggle("error", !!isError);
    }

    // ---- rooms UI ----
    function createRoomChip(value, labelText, checked = false) {
      const label = document.createElement("label");
      label.className = "room-chip";

      const cb = document.createElement("input");
      cb.type = "checkbox";
      cb.value = value;
      cb.checked = !!checked;

      const span = document.createElement("span");
      span.textContent = labelText;

      label.appendChild(cb);
      label.appendChild(span);

      return { label, cb };
    }

    function renderRoomCheckboxGroup(container, selectedRooms = []) {
      container.innerHTML = "";

      // ★ 共通（*）
      const common = createRoomChip("*", "全ルーム共通", selectedRooms.includes("*"));
      container.appendChild(common.label);

      // ルーム個別
      AVAILABLE_ROOMS.forEach(r => {
        const chip = createRoomChip(r, r, selectedRooms.includes(r));
        container.appendChild(chip.label);
      });

      // 挙動：* をONにしたら他をOFF、他をONにしたら * OFF
      const allCbs = Array.from(container.querySelectorAll('input[type="checkbox"]'));

      function applyRules(changedCb) {
        const isAll = changedCb.value === "*";

        if (isAll && changedCb.checked) {
          // * ON -> 他OFF
          allCbs.forEach(cb => {
            if (cb.value !== "*") cb.checked = false;
          });
        } else if (!isAll && changedCb.checked) {
          // 個別ON -> * OFF
          const all = allCbs.find(cb => cb.value === "*");
          if (all) all.checked = false;
        }
      }

      allCbs.forEach(cb => {
        cb.addEventListener("change", () => applyRules(cb));
      });
    }

    function getRoomsFromGroup(container) {
      const cbs = Array.from(container.querySelectorAll('input[type="checkbox"]'));
      const selected = cbs.filter(cb => cb.checked).map(cb => cb.value);

      if (selected.includes("*")) return ["*"];

      // 何も選ばれてない場合は「今見てるroom」に入れる（事故防止）
      if (selected.length === 0) return [getSelectedRoom()];

      return selected.map(normalizeRoomSlug);
    }

    function roomsLabel(rooms) {
      if (!Array.isArray(rooms) || rooms.length === 0) return "未設定";
      if (rooms.includes("*")) return "共通";
      return rooms.join(",");
    }

    // ---- render ----
    function renderTopics(list) {
      currentTopics = Array.isArray(list) ? list : [];
      topicsBody.innerHTML = "";

      if (currentTopics.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 4;
        td.textContent = "まだお題がありません。";
        td.style.textAlign = "center";
        td.style.color = "#6b7280";
        tr.appendChild(td);
        topicsBody.appendChild(tr);
        return;
      }

      currentTopics.forEach(topic => {
        const tr = document.createElement("tr");

        const tdId = document.createElement("td");
        tdId.className = "id-cell";
        tdId.textContent = topic.id;

        const tdText = document.createElement("td");
        tdText.className = "text-cell";
        tdText.textContent = topic.text;

        // rooms バッジ（表示だけ）
        const badge = document.createElement("span");
        badge.className = "badge";
        badge.textContent = `rooms: ${roomsLabel(topic.rooms)}`;
        tdText.appendChild(badge);

        const tdWeight = document.createElement("td");
        tdWeight.className = "weight-cell";
        tdWeight.textContent = topic.weight;

        const tdActions = document.createElement("td");
        tdActions.className = "actions-cell";

        const editBtn = document.createElement("button");
        editBtn.textContent = "編集";
        editBtn.onclick = () => editTopic(topic.id);

        const delBtn = document.createElement("button");
        delBtn.textContent = "削除";
        delBtn.className = "danger";
        delBtn.onclick = () => deleteTopic(topic.id);

        tdActions.appendChild(editBtn);
        tdActions.appendChild(delBtn);

        tr.appendChild(tdId);
        tr.appendChild(tdText);
        tr.appendChild(tdWeight);
        tr.appendChild(tdActions);

        topicsBody.appendChild(tr);
      });
    }

    // ---- API ----
    async function loadTopics() {
      const password = adminPasswordInput.value.trim();
      if (!password) { setStatus("管理パスワードを入力してください。", true); return; }

      const room = getSelectedRoom();

      try {
        setStatus(`読み込み中…（room: ${room}）`);
        const res = await fetch(`/api/topics?password=${encodeURIComponent(password)}&room=${encodeURIComponent(room)}`);
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || "読み込みに失敗しました。");
        }
        const list = await res.json();
        renderTopics(list);
        setStatus(`room:${room} のお題を ${list.length} 件読み込みました。`);
      } catch (err) {
        console.error(err);
        setStatus(err.message || "読み込み中にエラーが発生しました。", true);
      }
    }

    async function addTopicFromForm() {
      const password = adminPasswordInput.value.trim();
      if (!password) { setStatus("管理パスワードを入力してください。", true); return; }

      const room = getSelectedRoom();

      const text = newTopicText.value.trim();
      const weightVal = Number(newTopicWeight.value || "1");
      if (!text) { setStatus("お題テキストを入力してください。", true); return; }

      const rooms = getRoomsFromGroup(addRoomCheckboxes);

      try {
        setStatus(`追加中…（room: ${room}）`);
        const res = await fetch("/api/topics", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password, room, text, weight: weightVal, rooms })
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || "追加に失敗しました。");
        }
        await res.json();
        setStatus(`お題を追加しました。（rooms: ${roomsLabel(rooms)}）`);
        newTopicText.value = "";
        newTopicWeight.value = "1";
        // デフォルト選択は維持（次も同じ割当で追加しやすい）
        loadTopics();
      } catch (err) {
        console.error(err);
        setStatus(err.message || "追加中にエラーが発生しました。", true);
      }
    }

    async function editTopic(id) {
      const password = adminPasswordInput.value.trim();
      if (!password) { setStatus("管理パスワードを入力してください。", true); return; }

      const target = currentTopics.find(t => t.id === id);
      if (!target) { setStatus("対象のお題が見つかりませんでした。", true); return; }

      editingId = id;
      editTopicText.value = target.text || "";
      editTopicWeight.value = String(target.weight ?? 1);

      renderRoomCheckboxGroup(editRoomCheckboxes, Array.isArray(target.rooms) ? target.rooms : []);
      setEditStatus("");
      editDialog.showModal();
      editTopicText.focus();
    }

    editCancelBtn.addEventListener("click", () => editDialog.close());

    editSaveBtn.addEventListener("click", async () => {
      const password = adminPasswordInput.value.trim();
      if (!password) { setEditStatus("管理パスワードを入力してください。", true); return; }

      const room = getSelectedRoom();

      const newText = editTopicText.value.trim();
      const newWeight = Number(editTopicWeight.value || "1");

      if (!editingId) return;
      if (!newText) { setEditStatus("お題テキストを入力してください。", true); return; }
      if (!Number.isFinite(newWeight) || newWeight <= 0) {
        setEditStatus("重みは1以上の数字で指定してください。", true);
        return;
      }

      const rooms = getRoomsFromGroup(editRoomCheckboxes);

      try {
        setEditStatus(`更新中…（room: ${room}）`);
        const res = await fetch(`/api/topics/${editingId}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ password, room, text: newText, weight: newWeight, rooms })
        });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || "更新に失敗しました。");
        }
        await res.json();
        editDialog.close();
        setStatus(`お題を更新しました。（rooms: ${roomsLabel(rooms)}）`);
        loadTopics();
      } catch (err) {
        console.error(err);
        setEditStatus(err.message || "更新中にエラーが発生しました。", true);
      }
    });

    async function deleteTopic(id) {
      const password = adminPasswordInput.value.trim();
      if (!password) { setStatus("管理パスワードを入力してください。", true); return; }

      const room = getSelectedRoom();

      const target = currentTopics.find(t => t.id === id);
      const label = target ? `ID:${id}「${(target.text || "").slice(0, 20)}…」` : `ID:${id}`;
      const ok = window.confirm(`${label} を削除しますか？\n(room: ${room})`);
      if (!ok) return;

      try {
        setStatus(`削除中…（room: ${room}）`);
        const res = await fetch(
          `/api/topics/${id}?password=${encodeURIComponent(password)}&room=${encodeURIComponent(room)}`,
          { method: "DELETE" }
        );
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          throw new Error(data.error || "削除に失敗しました。");
        }
        await res.json();
        setStatus("お題を削除しました。");
        loadTopics();
      } catch (err) {
        console.error(err);
        setStatus(err.message || "削除中にエラーが発生しました。", true);
      }
    }

    // ---- wiring ----
    loadBtn.addEventListener("click", loadTopics);
    addBtn.addEventListener("click", addTopicFromForm);

    adminPasswordInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") loadTopics();
    });

    // グローバル（デバッグ用）
    window.editTopic = editTopic;
    window.deleteTopic = deleteTopic;

    // 初期化
    (async () => {
      await initRoomSelect();

      // 追加フォームの rooms 初期値：今見てるroomをチェック
      renderRoomCheckboxGroup(addRoomCheckboxes, [getSelectedRoom()]);
    })();
  </script>
</body>
</html>
